#!/usr/bin/env bash

#
# Sprawdzanie dokumentacji API przewoźników.
#
# TODO lista:
# [x] Allegro
# [x] AmbroExpress
# [ ] DeliGoo
# [x] DHL
# [ ] DHL Express
# [x] DPD
# [ ] Empik
# [x] FedEx
# [ ] GLS
# [x] InPost
# [ ] Meest
# [x] Orlen
# [x] Poczta
# [ ] Postivo
# [ ] Speedmail
# [ ] SPX
# [ ] UPS

date=$(date '+%Y%m%d%H%M%S')
case=$1
cache=~/.docs/$case
diff_log=~/.docs/log/${case}log_${date}
diff_args=(--color=always --palette='ad=1;3;38;5;154:de=1;3;38;5;9' --unified)
cookie_file=/tmp/${case}cookie

mkdir -p $cache
mkdir -p ~/.docs/log
touch $diff_log

echo "Checking $case at $(date)"

compare_html () {
    local link=$1

    sum=$(echo ${link} | md5sum | awk '{print $1}')
    new="$cache/${sum}new"
    prev="$cache/${sum}prev"
    tmp="$cache/${sum}tmp"

    curl -b ${cookie_file} -c ${cookie_file} -s "${link}" > $tmp

    cat "$tmp" | php -r '
      $html = file_get_contents("php://stdin");
      $html = preg_replace("/<style\b[^>]*>.*?<\/style>/is", "", $html);
      $html = preg_replace("/<script\b[^>]*>.*?<\/script>/is", "", $html);
      echo strip_tags($html);
    ' > "$new"

    rm $tmp

    if [ -e $prev ]; then
        diff=$(diff ${diff_args} $prev $new)

        if [ "${diff}" != "" ]; then
            echo "${link} has changed" >> $diff_log
            echo ${diff} >> $diff_log
        fi
    fi

    mv $new $prev
}

compare_json () {
    local link=$1

    sum=$(echo ${link} | md5sum | awk '{print $1}')
    new="$cache/${sum}new"
    prev="$cache/${sum}prev"
    tmp="$cache/${sum}tmp"

    curl -b ${cookie_file} -c ${cookie_file} -s "${link}" > $tmp

    cat $tmp | jq -S > $new
    rm $tmp

    if [ -e $prev ]; then
        diff=$(diff $diff_args $prev $new)

        if [ "${diff}" != "" ]; then
            echo "${link} has changed" >> $diff_log
            echo ${diff} >> $diff_log
        fi
    fi

    mv $new $prev
}

compare_strict () {
    local link=$1

    sum=$(echo ${link} | md5sum | awk '{print $1}')
    new="$cache/${sum}new"
    prev="$cache/${sum}prev"

    curl -b ${cookie_file} -c ${cookie_file} -s "${link}" > $tmp

    if [ -e $prev ]; then
        diff=$(diff ${diff_args} $prev $new)

        if [ "${diff}" != "" ]; then
            echo "${link} has changed" >> $diff_log
            echo ${diff} >> $diff_log
        fi
    fi

    mv $new $prev
}

compare_txt () {
    local new=$1
    local name=$(basename $new)

    prev="$cache/${name}prev"

    if [ -e $prev ]; then
        diff=$(diff ${diff_args} $prev $new)

        if [ "${diff}" != "" ]; then
            echo "${name} has changed" >> $diff_log
            echo ${diff} >> $diff_log
        fi
    fi

    mv $new $prev
}

case $case in
    allegro)
        compare_html 'https://developer.allegro.pl/changelog'

        curl -b ${cookie_file} -c ${cookie_file} -s 'https://developer.allegro.pl/news' | php -r '
            $html = file_get_contents("php://stdin");
            libxml_use_internal_errors(true);
            $doc = new DOMDocument();
            $doc->loadHTML($html);

            $xpath = new DOMXPath($doc);
            $nodes = $xpath->query("//div[@data-box-name=\"upcoming-changes\"]");

            foreach ($nodes as $node) {
                echo strip_tags($doc->saveHTML($node));
            }
        ' > /tmp/allegronews

        compare_txt '/tmp/allegronews'

        ;;

    ambroexpress)

        compare_html 'https://ambroexpress.pl/pliki-do-pobrania'

        curl -b ${cookie_file} -c ${cookie_file} -s "https://ambroexpress.pl/pliki-do-pobrania" \
            | grep -o -P "\/static\/upload.*?DokumentacjaAPI.*?[0-9]\.pdf" \
            | head -n 1 \
            | xargs -I{} wget --load-cookies ${cookie_file} -q -O /tmp/ambroexpressapi.pdf https://ambroexpress.pl{} && pdftotext -q /tmp/ambroexpressapi.pdf /tmp/ambroexpressapi.txt

        compare_txt "/tmp/ambroexpressapi.txt"

        rm /tmp/ambroexpressapi.pdf

        ;;

    dhl)
        compare_html 'https://dhl24.com.pl/webapi2/doc/index.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/zestawieniePolaczenia.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/przyklady.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/autoryzacyjna.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/adresowa.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/odbiorca.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/definicjaPaczki.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/serviceDefinition.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/customsData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/customsAgreementData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/customsItemData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/paymentData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemToPrint.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemToPrintResponse.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemReturnParams.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemReturnParamsResponse.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemsToLabelData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/itemsToLabelDataResponse.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/shipmentEvent.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/shipmentOrderInfo.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/shipmentBasicData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/shipmentFullData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getVersion.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/createShipments.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/bookCourier.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/deleteShipments.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/cancelCourierBooking.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getMyShipments.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getMyShipmentsCount.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getLabels.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getLabelsData.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getPieceId.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getPnp.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getShipmentScan.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getPostalCodeServices.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getReturnParams.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getTrackAndTraceInfo.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getNearestServicepoints.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getInternationalParams.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getInternationalParams2.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getRouting.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getPrice.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getIE599.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getEpod.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getNearestServicepointsAll.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/createShipment.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/deleteShipment.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/getReturnByWaybill.html'
        compare_html 'https://dhl24.com.pl/pl/webapi2/doc/info/createShipmentReturn.html'
        compare_strict 'https://dhl24.com.pl/webapi2.html'

        ;;

    dpd)
        compare_html 'https://www.dpd.com/pl/pl/oferta-dla-firm/rozwiazania-it-dpd-polska/implementacja-wtyczek-web-service-dpd-polska/'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/swagger-config'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/01.%20All%20methods'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/02.%20Post%20code%20verification'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/03.%20Data%20validation%20and%20notification%20and%20parcel%20numbers%20generation'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/04.%20Adding%20parcels%20to%20a%20shipment'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/05.%20Labels%20generation'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/06.%20Generation%20of%20a%20handing%20parcels%20protocol'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/07.%20Generation%20of%20a%20domestic%20return%20label'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/08.%20Generation%20of%20an%20international%20return%20label'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/09.%20Generation%20of%20package%20numbers%20for%20foreign%20returns'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/10.%20Data%20validation%20and%20notification%20of%20a%20shipment%20with%20a%20predefined%20waybill%20number'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/11.%20Data%20validation,%20notification%20of%20shipments%20with%20a%20predefined%20waybill%20number%20and%20labels%20generation'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/12.%20Courier%20order'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/13.%20Courier%20availability%20check%20for%20postal%20codes'
        compare_json 'https://dpdservices.dpd.com.pl/api-docs/14.%20Generation%20of%20drop%20off%20pins%20for%20parcels'

        curl -b ${cookie_file} -c ${cookie_file} -s "https://www.dpd.com/pl/pl/oferta-dla-firm/rozwiazania-it-dpd-polska/implementacja-wtyczek-web-service-dpd-polska/" \
            | grep -o -E "(https://www.dpd.com/.*?DPD-Services.*?.zip)" \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/dpdservicesdocs && unzip -Z -1 /tmp/dpdservicesdocs \
            | grep pdf \
            | xargs -I{} unzip -p -j /tmp/dpdservicesdocs {} > /tmp/dpdservicesdocs.pdf && pdftotext -q /tmp/dpdservicesdocs.pdf /tmp/dpdservicesdocs.txt

        compare_txt "/tmp/dpdservicesdocs.txt"

        curl -b ${cookie_file} -c ${cookie_file}  -s "https://www.dpd.com/pl/pl/oferta-dla-firm/rozwiazania-it-dpd-polska/implementacja-wtyczek-web-service-dpd-polska/" \
            | grep -o -E "(https://www.dpd.com/.*?APP-services.*?.zip)" \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/dpdappservicesdocs && unzip -Z -1 /tmp/dpdappservicesdocs \
            | grep pdf \
            | xargs -I{} unzip -p -j /tmp/dpdappservicesdocs {} > /tmp/dpdappservicesdocs.pdf && pdftotext -q /tmp/dpdappservicesdocs.pdf /tmp/dpdappservicesdocs.txt

        compare_txt "/tmp/dpdappservicesdocs.txt"

        curl -b ${cookie_file} -c ${cookie_file}  -s "https://www.dpd.com/pl/pl/oferta-dla-firm/rozwiazania-it-dpd-polska/implementacja-wtyczek-web-service-dpd-polska/" \
            | grep -o -E "(https://www.dpd.com/.*?InfoServices.*?.zip)" \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/dpdinfoservicesdocs && unzip -Z -1 /tmp/dpdinfoservicesdocs \
            | grep pdf \
            | xargs -I{} unzip -p -j /tmp/dpdinfoservicesdocs {} > /tmp/dpdinfoservicesdocs.pdf && pdftotext -q /tmp/dpdinfoservicesdocs.pdf /tmp/dpdinfoservicesdocs.txt

        compare_txt "/tmp/dpdinfoservicesdocs.txt"

        curl -b ${cookie_file} -c ${cookie_file}  -s "https://www.dpd.com/pl/pl/oferta-dla-firm/rozwiazania-it-dpd-polska/implementacja-wtyczek-web-service-dpd-polska/" \
            | grep -o -E "(https://www.dpd.com/.*?DPDPickupServices.*?.zip)" \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/dpdpickupservicesdocs && unzip -Z -1 /tmp/dpdpickupservicesdocs \
            | grep pdf \
            | xargs -I{} unzip -p -j /tmp/dpdpickupservicesdocs {} > /tmp/dpdpickupservicesdocs.pdf && pdftotext -q /tmp/dpdpickupservicesdocs.pdf /tmp/dpdpickupservicesdocs.txt

        compare_txt "/tmp/dpdpickupservicesdocs.txt"

        rm /tmp/dpdservicesdocs /tmp/dpdservicesdocs.pdf \
           /tmp/dpdappservicesdocs /tmp/dpdappservicesdocs.pdf \
           /tmp/dpdinfoservicesdocs /tmp/dpdinfoservicesdocs.pdf \
           /tmp/dpdpickupservicesdocs /tmp/dpdpickupservicesdocs.pdf

        ;;

    fedex)

        compare_json 'https://developer.fedex.com/api/etc/services/fetchislands.jsonp?data=%7B%22tagPage%22%3A%22irc%3ATop-Group%22%2C%22tagParentPath%22%3A%22%2Fcontent%2Ffedex-com%2Firc%2Fsites%2Fpl%2Fpl_pl%2Fcatalog%22%2C%22type%22%3A%22catalog%22%2C%22fullfeed%22%3Atrue%7D'
        compare_html 'https://developer.fedex.com/api/pl-pl/catalog/ship/v1/docs.html'
        compare_json 'https://developer.fedex.com/wirc/json/api_groups/Ship/Shipment-Resource.json'
        compare_html 'https://developer.fedex.com/api/pl-pl/catalog/postal-code/v1/docs.html#operation/Validate%20Postal'
        compare_json 'https://developer.fedex.com/wirc/json/api_groups/CountryAPI/ValidatePostal-Resource.json'
        compare_html 'https://developer.fedex.com/api/pl-pl/catalog/pickup/v1/docs.html'
        compare_json 'https://developer.fedex.com/wirc/json/api_groups/Pickup/Pickup-Resource.json'

        ;;

    inpost)

        compare_html "https://dokumentacja-inpost.atlassian.net/wiki"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/plugins/recently-updated/changes.action?theme=sidebar&startIndex=15&searchToken=1&spaceKeys=PL&contentType=page&cursor=_t_WzE3NTk0ODM2NDEwMDAsIlx0MzUyMjIzNTAxIDk8NDFgP2htSWlKQ25iPUxFLDVKIGNwIl0%3D_h_W10%3D"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11730958/PL+Dokumentacja+us+ugi+Paczka+w+Weekend"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731040/Dokumentacja+API+ShipX"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731042/Us+ugi"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731043/Walidacja+formularzy"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731045/Zlecenie+odbioru+Zamawianie+kuriera"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731046/Przesy+ka"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731047/Spos+b+nadania"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731048/Miejsce+powstania+koszt+w+MPK"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731050/Tracking+przesy+ki"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731054/Organizacja"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731055/Autoryzacja+Kolekcje+zapyta"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731056/Statusy"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/11731074/Raport+COD"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/130351113/Autoryzacja+i+wymagania+techniczne"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/18153470/Zas+b+Points+Paczkomat+PaczkoPunkty"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/18153630/Webhooki"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/352223501/Order"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/40206337/Proces+integracji+z+us+ugami+InPost"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/451084324/InPost+International+API+Documentation+0.2"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/451903492/InPost+Integration+FAQ"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/45744192/Prezentowanie+punkt+w+odbioru"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/52428808/FAQ"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/622754/API+ShipX"
        compare_html "https://dokumentacja-inpost.atlassian.net/wiki/spaces/PL/pages/839974914/International"

        ;;

    poczta)
        curl -b ${cookie_file} -c ${cookie_file} -s "https://e-nadawca.poczta-polska.pl" > /dev/null

        compare_html 'https://e-nadawca.poczta-polska.pl/?action=GetAbout'

        curl -b ${cookie_file} -c ${cookie_file} -s "https://e-nadawca.poczta-polska.pl/?action=GetAbout" \
            | grep -o -P "https:\/\/e-nadawca.poczta-polska\.pl\/download\/en_webapi_.*?zip" \
            | head -n 1 \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/pocztawebapi && unzip -Z -1 /tmp/pocztawebapi \
            | grep pdf \
            | head -n 1 \
            | xargs -I{} unzip -p -j /tmp/pocztawebapi {} > /tmp/pocztawebapi.pdf && pdftotext -q /tmp/pocztawebapi.pdf /tmp/pocztawebapi.txt

        compare_txt "/tmp/pocztawebapi.txt"

        rm /tmp/pocztawebapi /tmp/pocztawebapi.pdf

        ;;

    orlen)
        curl -b ${cookie_file} -c ${cookie_file} -s "https://www.orlenpaczka.pl/integracja-z-orlen-paczka/" > /dev/null

        compare_html 'https://www.orlenpaczka.pl/integracja-z-orlen-paczka/'

        curl -b ${cookie_file} -c ${cookie_file} -s "https://www.orlenpaczka.pl/integracja-z-orlen-paczka/" \
            | grep -o -P "https:\/\/www\.orlenpaczka\.pl.*uploads.*API_ORLENPaczka.*PL\.pdf" \
            | head -n 1 \
            | xargs wget --load-cookies ${cookie_file} -q -O /tmp/orlenapi.pdf && pdftotext -q /tmp/orlenapi.pdf /tmp/orlenapi.txt

        compare_txt "/tmp/orlenapi.txt"

        rm /tmp/orlenapi.pdf

        ;;

    *)
        $0 allegro
        $0 ambroexpress
        # $0 deligoo
        $0 dhl
        # $0 dhlexpress
        $0 dpd
        # $0 empik
        $0 fedex
        # $0 gls
        $0 inpost
        # $0 meest
        $0 orlen
        $0 poczta
        # $0 postivo
        # $0 speedmail
        # $0 spx
        # $0 ups

        ;;
esac

[ -n "${cache}" ] || rm ${cache}
[ -s "${diff_log}" ] || rm ${diff_log}

echo "Done $case at $(date)"
