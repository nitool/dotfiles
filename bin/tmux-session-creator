#!/bin/bash

options=()
parseOptions () {
	options=()
	echo $@
	exit 0
	while IFS=  read -r -d $'\0'; do
		options+=("$REPLY")
	done < <(echo $@)
}

init_path=$1
find_level=$2
query=""
options=()
index=0
while IFS=  read -r -d $'\0'; do
	options+=("$REPLY")
done < <(find ${init_path} -mindepth ${find_level} -maxdepth ${find_level} -type d -iname "*${query}*" -print0)

while [ true ]; do
	clear
	if [ -n "${query}" ]; then
		options=()
		while IFS=  read -r -d $'\0'; do
			options+=("$REPLY")
		done < <(find ${init_path} -mindepth ${find_level} -maxdepth ${find_level} -type d -iname "*${query}*" -print0)
	fi

	for option in "${!options[@]}"
	do
		path=${options[${option}]}
		if [ ${option} -eq ${index} ]; then
		   path="+ "${path}
		fi

		echo "${path}"
	done

    while IFS= read -p "${query}" -r -s -n 1 key  
    do
        case "$key" in
            $'\033') 
                exit 0
                ;;
            "") 
                new_session=$(tmux new-session -c ${options[${index}]} -d -P)
                if [ -z "${TMUX}" ]; then
                    tmux attach-session -t "${new_session}"
                else
                    tmux switch -t "${new_session}"
                fi
                
                exit 0
                ;;
            ',') 
                echo 'up'
                index=$((index-1))
                if [ ${index} -lt 0 ]; then
                    index=0
                elif [ ${index} -gt ${#options[@]} ]; then
                    index=$(({options[@]}-1))
                fi

                break
                ;;
            '.') 
                echo 'down'
                index=$((index+1))
                if [ ${index} -gt ${#options[@]} ]; then
                    index=$(({options[@]}-1))
                fi

                break
                ;;
            $'\177') 
                query=${query%?}
                break
                ;;
            *)
                query+=${key}
                ;;
        esac

        break
    done
done

